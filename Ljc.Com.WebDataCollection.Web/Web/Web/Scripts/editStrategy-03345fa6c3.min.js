$(".journal-list li").on("click",function(){$(this).addClass("add-border-li").siblings().removeClass("add-border-li");var e=$(this).index();$(".journal-detal .change-box").hide().eq(e).show()}),$(".jour-down").on("click",function(){$(this).toggleClass("jour-up"),$(this).hasClass("jour-up")?($(this).parent(".journal").addClass("journal-marg"),$(".bianji-con").hide()):($(this).parent(".journal").removeClass("journal-marg"),$(".bianji-con").show())}),$(".x-quan").on("click",function(){$(this).parents(".edit-container-leftbar").toggleClass("edt-gai")});var sourceCodeBody=$("#sourceCode1").val(),autoComplateData=null;$().ready(function(){function e(e){for(var a=e.length,t=[],s=0,o=[],n=0;a>=0;a--)")"==e.charAt(a)&&(n++,o.push(a)),"("==e.charAt(a)&&(n--,0==n?t.push(a):s=a);return 0==n?0!=o.length?e.substring(0,t[0])+e.substring(o[0]+1):e.substring(0,t[0]):e.substring(s+1)}function a(e,a,t,s){var o=[];if(e.typePropMap[a]){$.each(e.typePropMap[a],function(e,a){$.each(a,function(e,a){if("func"==a.type){var t=a.showPara?"("+a.showPara.join(", ")+")":"";o.push({value:a.name+"()",caption:a.name+t,meta:a.showRetType||a.retType})}else o.push({value:a.name,caption:a.name,meta:a.showRetType||a.retType})})});var n={getCompletions:function(e,a,t,s,n){n(null,$.grep(o,function(e){return e.value.indexOf(s)>=0}).map(function(e){return{value:e.value,meta:e.meta,caption:e.caption}}))}};t.completers=[n],t.execCommand("startAutocomplete"),t.completers=s}}var t=ace.edit("sourceCode");t.setTheme("ace/theme/xcode"),"java"==$("#languageType").val()?t.getSession().setMode("ace/mode/java"):t.getSession().setMode("ace/mode/python"),t.setValue(sourceCodeBody,-1),t.setFontSize(14),t.setShowPrintMargin(!1),1==$("#simulationStatus").val()?(strategy.editVue.canEdit=!1,t.setReadOnly(!0),t.getSession().setUseWrapMode(!0),$("#sourceCode").on("input",function(){alert("该策略无法编辑!")}),$("#strategyName").attr("readonly",!0),$("#editMessage").html("模拟中的策略无法编辑").show()):($("#sourceCode").on("input",function(){$("#strategySaveBtn").html("保存").removeClass("add-preservation"),$("#strategySaveBtn").attr("data-disabled",!1)}),$("#strategyName").change(function(){$("#strategySaveBtn").html("保存").removeClass("add-preservation"),$("#strategySaveBtn").attr("data-disabled",!1)})),$(".status-bar").draggable(),t.commands.addCommand({name:"startStockSearch",bindKey:{win:"Ctrl-I",mac:"Command-I"},exec:function(e){strategy.stockNotify=!strategy.stockNotify,strategy.stockNotify?strategy.startStockSearch(e):strategy.closeStockSearch(e)}}),t.commands.addCommand({name:"saveCodeSource",bindKey:{win:"Ctrl-S",mac:"Command-S"},exec:function(e){$("#strategySaveBtn").click()}}),t.commands.on("afterExec",function(t,s){if("insertstring"==t.command.name&&"."==t.args){var o=t.editor.completers,n=t.editor.selection.getCursor(),r=t.editor.session.getLine(n.row).substring(0,n.column),i=/\w+/,l=/\w+/g,c=/\([^\)]*\)/g;for(r=e(r);r!=e(r);)r=e(r);if(r=r.replace(c,""),i.test(r.charAt(r.length-2))){var d=r.match(l);if(d){var m=d[d.length-1];autoComplateData.nameTypeMap[m]&&a(autoComplateData,autoComplateData.nameTypeMap[m],t.editor,o);var u=[];$.each(autoComplateData.typePropMap,function(e,s){var n=d[d.length-2];$.each(autoComplateData.typePropMap,function(e,a){a[n]&&$.each(a[n],function(e,a){u.push(a.retType)})}),s[m]&&$.each(s[m],function(s,n){(0==u.length||u.join(",").indexOf(e)>=0)&&a(autoComplateData,n.retType,t.editor,o)})})}}}}),t.gotoLine(1),strategy.enableCodeHinting(t),$("#logarea").scroll(function(){var e=$("#logarea").height();($("#logarea")[0].scrollHeight-e-$("#logarea").scrollTop())/e<.05&&strategy.editVue.readLogs(100)})}),window.localStorage.getItem("hasSeeEditGuide")||($(".bianyi").addClass("ad-bian"),$(".windowmask").show(),$(".state-wrap4").show(),$(".state4").one("click",function(){$(".state-wrap4").hide(),$(".state-wrap5").show(),$(".bianyi").removeClass("ad-bian"),$(".edi-wraps").addClass("add-edi-wraps")}),$(".state4-close").one("click",function(){$(".state-wrap4").hide(),$(".windowmask").hide(),$(".state-wrap6").remove(),$(".state-wrap5").remove(),window.localStorage.setItem("hasSeeEditGuide",!0)}),$(".bianyi").one("click",function(){$(".state-wrap4").hide(),$(".state-wrap5").show(),$(this).removeClass("ad-bian"),$(".edi-wraps").addClass("add-edi-wraps")}),$(".state5").one("click",function(){$(".state-wrap5").remove(),$(".state-wrap6").show(),$(".edi-wraps").removeClass("add-edi-wraps"),$(".journal").addClass("add-journal")}),$(".renturn-back").one("click",function(){$(".state-wrap5").remove(),$(".state-wrap6").show(),$(".edi-wraps").removeClass("add-edi-wraps"),$(".journal").addClass("add-journal")}),$(".state6").one("click",function(){$(".state-wrap6").remove(),$(".windowmask").hide(),$(".journal").removeClass("add-journal"),window.localStorage.setItem("hasSeeEditGuide",!0)}),$(".state6-close").one("click",function(){$(".state-wrap6").hide(),$(".windowmask").hide(),$(".journal").removeClass("add-journal"),window.localStorage.setItem("hasSeeEditGuide",!0)}),$(".state5-close").one("click",function(){$(".state-wrap6").remove(),$(".state-wrap5").hide(),$(".windowmask").hide(),$(".edi-wraps").removeClass("add-edi-wraps"),window.localStorage.setItem("hasSeeEditGuide",!0)}));var strategy=new function(){"use strict";function e(){var e=$("#endDate").val(),a=[["week",[1]],["month",[1,2,3,4,6]]];HighChartsUtil.initCharts({container:"backTestChart",title:"量化交易收益图",xAxis:{minorTickInterval:5,minTickInterval:80,max:new Date(e).getTime(),gridLineWidth:1,startOnTick:!0,ordinal:!1,dateTimeLabelFormats:{second:"%Y-%m-%d<br/>%H:%M:%S",minute:"%Y-%m-%d<br/>%H:%M",hour:"%Y-%m-%d<br/>%H:%M",day:"%Y<br/>%m-%d",week:"%Y<br/>%m-%d",month:"%Y-%m",year:"%Y"}},yAxis:[{minorTickInterval:"auto",minorTickLength:10,labels:{align:"right",format:"{value}%",x:-3},opposite:!0,height:"100%",lineWidth:0,plotLines:[{value:0,width:1,color:"#808080"}]}],seriesArray:[{type:"spline",name:S.name,data:S.data,dataGrouping:{units:a},tooltip:{valueSuffix:"%"}},{type:"areaspline",name:C.name,data:C.data,dataGrouping:{units:a},tooltip:{valueSuffix:"%"}}]})}function a(e){if(e){$("#hcsy").html((100*e.quantSummary.cumulativePercent).toFixed(2)+"<span>%</span>"),$("#hcnhsy").html((100*e.quantSummary.yearPercent).toFixed(2)+"<span>%</span>"),$("#jzsy").html((100*e.quantSummary.benchmarkPercent).toFixed(2)+"<span>%</span>"),$("#alpha").html(e.quantSummary.alpha.toFixed(4)),$("#sharpe").html(e.quantSummary.sharpe.toFixed(4)),$("#zdhc").html((100*e.quantSummary.fall).toFixed(2)+"<span>%</span>"),$("#compileValue").html(e.runPercent+"%");var a=$(".b-du").width();$("#compileBar").width(e.runPercent*a/100)}}function t(e){try{var a=JSON.parse(e);a&&a.success?(s(a),a.end&&($(".b-jin").hide(),$("#compileValue").html("0%"),$("#compileBar").width(0),g.backTestStatus="回测完成")):($(".b-jin").hide(),$("#compileValue").html("0%"),$("#compileBar").width(0),$("#errorarea").addClass("chang-show"),$("#errorTab").addClass("add-border-li"),$("#logTab").removeClass("add-border-li"),$("#logarea").removeClass("chang-show"),$("#logarea").hide(),$("#errorarea").show(),$("#errorarea").html("<pre>"+a.message.replace(new RegExp(/(<)/g),"&lt;").replace(new RegExp(/(>)/g),"&gt;")+"</pre><br/>"))}catch(e){}}function s(t){if(t.dayProfitVo&&(w=t.dayProfitVo),t.logOutputs&&(c=c.concat(t.logOutputs)),!t.data)return!1;if(b){var s=$("#backTestChart").highcharts();S.data=S.data.concat(t.data.incomeList[0].data),C.data=C.data.concat(t.data.incomeList[1].data),s.series[0].setData(S.data),s.series[1].setData(C.data)}else{if($("#logarea").html(""),d<50&&!m){g.readLogs(100),m=!0;var o=setInterval(function(){g.readLogs(100),console.log("已显示日志条数："+d),d>=50&&(console.log("####Stop auto loading logs!####"),clearInterval(o))},3e3)}S=t.data.incomeList[0],C=t.data.incomeList[1],S&&S.data&&0!=S.data.length&&(b=!0,e())}a(w)}function o(e){var a=p.getValue(),t=Base64.encode(a);return""==a||void 0==a||null==a||""==$.trim(a)?($("#message").text("策略代码不能为空！"),l.showLayer($("#responseBox")),!1):""==$.trim($("#strategyName").val())?($("#message").text("策略名称不可为空！"),l.showLayer($("#responseBox")),!1):void $.post("/strategy/saveStrategy",{userPin:$("#userPin").val(),strategyId:$("#strategyId").val(),strategyName:$("#strategyName").val(),sourceCode:e?t:null,startDate:$("#startDate").val()+" 00:00:00",endDate:$("#endDate").val()+" 23:59:59",regressionType:$("#regressionType").attr("data-value"),principal:$("#principal").val(),languageType:$("#languageType").val()}).done(function(e){if(e.success){if(v)return window.location.href="/run/"+$("#strategyId").val(),!1;if(y)return n(),y=!1,!1;$("#strategySaveBtn").html("已保存").addClass("add-preservation"),$("#strategySaveBtn").attr("data-disabled",!0),setTimeout("$('#strategySaveBtn').html('保存').removeClass('add-preservation'); $('#strategySaveBtn').attr('data-disabled', false);",3e3)}else $("#message").text(e.message),l.showLayer($("#responseBox"))})}function n(){var e=p.getValue();if(""==e||void 0==e||null==e||""==jQuery.trim(e))return $("#message").text("策略代码不能为空！"),l.showLayer($("#responseBox")),!1;if(new Date($("#startDate").val()).getTime()>new Date($("#endDate").val()).getTime())return $("#message").text("时间区域选择不正确！"),l.showLayer($("#responseBox")),!1;r(),$(".b-jin").show();var a=(new Date).getTime();$("#requestTime").val(a),$("#logarea").html("<span class='b-jin-text'>请稍后，正在进行编译...</span>"),null==f||f.readyState==SockJS.CLOSED?(f=new SockJS("//"+window.location.host+"/getResult",null,{protocols_whitelist:["websocket"]}),f.onopen=function(){console.log("Socket is Open!"),f.send(JSON.stringify({userPin:$("#userPin").val(),strategyId:$("#strategyId").val(),requestTime:$("#requestTime").val(),isReconnect:!1}))},f.onmessage=function(e){t(e.data)},f.onclose=function(){console.log("Socket Close!")}):f.send(JSON.stringify({userPin:$("#userPin").val(),strategyId:$("#strategyId").val(),requestTime:a}))}function r(){$("#hcsy").html("--"),$("#hcnhsy").html("--"),$("#jzsy").html("--"),$("#alpha").html("--"),$("#sharpe").html("--"),$("#zdhc").html("--"),$("#backTestChart").html(""),$("#logarea").html(""),$("#errorarea").html(""),b=!1,d=0,m=!1,c=[]}function i(e){var a={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;","/":"&#x2F;"};return String(e).replace(/[&<>"'\/]/g,function(e){return a[e]})}var l=null;seajs.use("financial/common/module/popup/1.0.0/js/popup",function(e){l=e});var c=[],d=0,m=!1,u=ace.require("ace/ext/language_tools"),p=ace.edit("sourceCode"),h={format:"YYYY-MM-DD",minDate:new Date(2011,4,1),maxDate:new Date((new Date).getFullYear(),(new Date).getMonth(),(new Date).getDate()-1),yearRange:[2011,2017],i18n:{previousMonth:"上个月",nextMonth:"下个月",months:["一月","二月","三月","四月","五月","六月","七月","八月","九月","十月","十一月","十二月"],weekdays:["星期日","星期一","星期二","星期三","星期四","星期五","星期六"],weekdaysShort:["周日","周一","周二","周三","周四","周五","周六"]}},g=($("#startDate").pikaday(h),$("#endDate").pikaday(h),new Vue({el:"#vueArea",data:{canEdit:!0,versionId:null,backTestStatus:"回测中",dayProfits:[]},methods:{readLogs:function(e){if(console.log("Read Log starting..."),c.length>e)for(var a=0;a<e;a++){d++;var t=c.shift(),s=" <span style='color: #393'>"+t.level+"</span> ";"ERROR"==t.level&&(s=" <span style='color: #ff5d5b'>"+t.level+"</span> ");var o="SYSTEM";t.date&&(o=new Date(t.date).format("yyyy-MM-dd hh:mm:ss")),$("#logarea").append("<span style='color: #5584ff'>"+o+"</span>"+s+"<pre style='display: inline-block; margin: 0'>"+i(t.content)+"</pre><br/>")}else for(var n=c.length,a=0;a<n;a++){d++;var t=c.shift(),s=" <span style='color: #393'>"+t.level+"</span> ";"ERROR"==t.level&&(s=" <span style='color: #ff5d5b'>"+t.level+"</span> ");var o="SYSTEM";t.date&&(o=new Date(t.date).format("yyyy-MM-dd hh:mm:ss")),$("#logarea").append("<span style='color: #5584ff'>"+o+"</span>"+s+"<pre style='display: inline-block; margin: 0'>"+i(t.content)+"</pre><br/>")}}}})),v=!1;this.editVue=g;var y=!1,f=null;this.changeKeyboard=function(e){e&&"string"==typeof e&&("vim"==e?(p.setKeyboardHandler("ace/keyboard/vim"),$("#vimKey").addClass("col-red"),$("#emacsKey").removeClass("col-red"),$("#defaultKey").removeClass("col-red")):"emacs"==e?(p.setKeyboardHandler("ace/keyboard/emacs"),$("#emacsKey").addClass("col-red"),$("#vimKey").removeClass("col-red"),$("#defaultKey").removeClass("col-red")):"default"==e&&(p.setKeyboardHandler(),$("#defaultKey").addClass("col-red"),$("#emacsKey").removeClass("col-red"),$("#vimKey").removeClass("col-red")))},this.changeTheme=function(e){e&&"string"==typeof e&&("xcode"==e?(p.setTheme("ace/theme/xcode"),$("#xcodeTheme").addClass("col-red"),$("#monokaiTheme").removeClass("col-red")):"monokai"==e&&(p.setTheme("ace/theme/monokai"),$("#monokaiTheme").addClass("col-red"),$("#xcodeTheme").removeClass("col-red")))},this.changeFontSize=function(e){e&&"number"==typeof e&&(12==e?(p.setFontSize(e),$("#minFontSize").addClass("col-red"),$("#midFontSize").removeClass("col-red"),$("#maxFontSize").removeClass("col-red")):14==e?(p.setFontSize(e),$("#midFontSize").addClass("col-red"),$("#minFontSize").removeClass("col-red"),$("#maxFontSize").removeClass("col-red")):16==e&&(p.setFontSize(e),$("#maxFontSize").addClass("col-red"),$("#minFontSize").removeClass("col-red"),$("#midFontSize").removeClass("col-red")))},this.openSearch=function(){p.execCommand("find")},this.selectRegressionType=function(e){$("#regressionType").attr("data-value",$(e).attr("data-value"))},this.startStockSearch=function(e){console.log("开启股票搜索..."),$(".status-bar").addClass("status-bar-active"),$(".status-bar").html($(".status-bar").attr("data-close")),e.commands.addCommand({name:"exitStockSearch",bindKey:{win:"Esc|Return",mac:"Esc|Return",sender:"editor|cli"},exec:function(e){strategy.stockNotify=!1,strategy.closeStockSearch(e)}});var a={getCompletions:function(e,a,t,s,o){if(0===s.length)return void o(null,[]);o(null,stocks.map(function(e){return{name:e.value,value:e.value,caption:e.caption,meta:e.meta}}))}};u.setCompleters([a]),e.setOptions({enableBasicAutocompletion:!0})},this.closeStockSearch=function(e){console.log("关闭股票搜索"),$(".status-bar").removeClass("status-bar-active"),$(".status-bar").html($(".status-bar").attr("data-enter")),e.commands.removeCommand("exitStockSearch"),strategy.enableCodeHinting(e)},this.enableCodeHinting=function(e){var a=[],t=[],s=$("#languageType").val();$.getJSON("Scripts/"+s+"-api.json.txt",function(o){autoComplateData=o;var n=o.nameTypeMap,r=o.typePropMap,i=o.staticMethodMap;$.each(n,function(e,s){a.push({value:e||s,caption:e,meta:s?e.charAt(0).match(/[A-Z]/)?"SDK Class":"Local":"Keyword"}),r[s]&&$.each(r[s],function(a,s){$.each(s,function(a,s){if("func"==s.type){var o=s.showPara?"("+s.showPara.join(", ")+")":"";t.push({value:e+"."+s.name+"()",caption:e+"."+s.name+o,meta:s.showRetType||s.retType})}else t.push({value:e+"."+s.name,caption:e+"."+s.name,meta:s.showRetType||s.retType})})})}),"python"==s&&($.each(r,function(e,a){$.each(a,function(a,s){$.each(s,function(a,s){if("func"==s.type){var o=s.showPara?"("+s.showPara.join(", ")+")":"";t.push({value:e+"."+s.name+"()",caption:e+"."+s.name+o,meta:s.showRetType||s.retType})}else t.push({value:e+"."+s.name,caption:e+"."+s.name,meta:s.showRetType||s.retType})})})}),$.each(i,function(e,a){t.push({value:e+"()",caption:e+"("+a.showPara.join(", ")+")",meta:a.showRetType})}));var l=a.concat(t),c={getCompletions:function(e,a,t,s,o){if(0===s.length)return void o(null,[]);o(null,$.grep(l,function(e){return e.value.indexOf(s)>=0}).map(function(e){return{value:e.value,meta:e.meta,caption:e.caption}}))}};u.setCompleters([u.snippetCompleter,u.textCompleter,u.keyWordCompleter,c]),e.setOptions({enableBasicAutocompletion:!0,enableSnippets:!0,enableLiveAutocompletion:!0})})};var w,S={},C={},b=!1;this.copyStrategy=function(){$.getJSON("/strategy/copyStrategy",{strategyId:$("#strategyId").val()}).done(function(e){e.success?window.location.href="/strategy/edit/"+e.strategyId:($("#message").text(e.message),l.showLayer($("#responseBox")))})},this.save=function(){g.canEdit&&(y=!1,v=!1,o(!0))},this.compile=function(){if("java"==$("#languageType").val())return void l.showLayer($("#javaSystemUpdate1"));var e=p.getValue();return""==e|void 0==e|null==e|""==jQuery.trim(e)?($("#message").text("策略代码不能为空！"),l.showLayer($("#responseBox")),!1):new Date($("#startDate").val()).getTime()>new Date($("#endDate").val()).getTime()?($("#message").text("时间区域选择不正确！"),l.showLayer($("#responseBox")),!1):(y=!0,g.logRequestId=null,g.backTestStatus="回测中",void o(g.canEdit?!0:!1))},this.backTest=function(){if("java"==$("#languageType").val())return void l.showLayer($("#javaSystemUpdate1"));var e=p.getValue();return""==e|void 0==e|null==e|""==jQuery.trim(e)?($("#message").text("策略代码不能为空！"),l.showLayer($("#responseBox")),!1):new Date($("#startDate").val()).getTime()>new Date($("#endDate").val()).getTime()?($("#message").text("时间区域选择不正确！"),l.showLayer($("#responseBox")),!1):(v=!0,void o(g.canEdit?!0:!1))},this.cancelTest=function(){$.getJSON("/run/cancelTest",{strategyId:$("#strategyId").val(),requestTime:$("#requestTime").val()}).done(function(e){e.success?(console.log(e.message),$(".b-jin").hide(),$("#compileValue").html("0%"),$("#compileBar").width(0),f.close()):($("#message").text(e.message),l.showLayer($("#responseBox")))})},this.closeMessageBox=function(){l.hideLayer($("#responseBox"))},this.closeMessageBox1=function(){l.hideLayer($("#javaSystemUpdate1"))}};